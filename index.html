<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroFlow 9.0 - Exp√©rience Fluide</title>
    
    <!-- OUTILS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* DESIGN SYSTEM */
        body { 
            background-color: #020617; 
            color: #f8fafc; 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(56, 189, 248, 0.08), transparent 25%), 
                radial-gradient(circle at 85% 30%, rgba(168, 85, 247, 0.08), transparent 25%);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }

        .glass { 
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }
        
        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.4), rgba(15, 23, 42, 0.4));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .glass-card:hover {
            transform: translateY(-4px);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
        }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-float { animation: float 6s ease-in-out infinite; }

        /* Input Autofill Fix */
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus, 
        input:-webkit-autofill:active{
            -webkit-box-shadow: 0 0 0 30px #0f172a inset !important;
            -webkit-text-fill-color: white !important;
            transition: background-color 5000s ease-in-out 0s;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- FIREBASE MODULES -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';

        // Expos√© globalement pour React
        window.db = db;
        window.auth = auth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.appId = appId;
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, AreaChart, Area } = Recharts;

        // --- CONSTANTES ---
        const MAX_DAILY_REVIEWS = 1;
        const COLLECTION_NAME = 'neuroflow_users_v9'; 

        const LEVELS = [
            { lvl: 1, xp: 0, title: "Novice", reward: { type: 'theme', id: 'blue', name: 'Th√®me Oc√©an' } },
            { lvl: 2, xp: 200, title: "Apprenti", reward: { type: 'avatar', id: 'ü¶Å', name: 'Avatar Lion' } },
            { lvl: 3, xp: 500, title: "Initi√©", reward: { type: 'theme', id: 'purple', name: 'Th√®me N√©on' } },
            { lvl: 4, xp: 1000, title: "Expert", reward: { type: 'trophy', id: 'ü•â', name: 'M√©daille Bronze' } },
            { lvl: 5, xp: 2000, title: "Ma√Ætre", reward: { type: 'avatar', id: 'üöÄ', name: 'Avatar Astronaute' } },
            { lvl: 6, xp: 3500, title: "Grand Ma√Ætre", reward: { type: 'theme', id: 'gold', name: 'Th√®me Royal' } },
            { lvl: 10, xp: 10000, title: "L√©gende", reward: { type: 'trophy', id: 'üèÜ', name: 'Coupe Ultime' } }
        ];

        const THEMES = {
            blue: { bg: 'from-cyan-500 to-blue-600', text: 'text-cyan-400', border: 'border-cyan-500', shadow: 'shadow-cyan-500/20' },
            purple: { bg: 'from-fuchsia-500 to-purple-600', text: 'text-fuchsia-400', border: 'border-fuchsia-500', shadow: 'shadow-fuchsia-500/20' },
            gold: { bg: 'from-amber-400 to-orange-600', text: 'text-amber-400', border: 'border-amber-500', shadow: 'shadow-amber-500/20' },
            green: { bg: 'from-emerald-400 to-teal-600', text: 'text-emerald-400', border: 'border-emerald-500', shadow: 'shadow-emerald-500/20' }
        };

        const SUBJECTS = [
            { id: 'maths', name: 'Maths', color: '#f43f5e', icon: 'üìê', gradient: 'from-rose-500 to-red-600' },
            { id: 'phys', name: 'Physique', color: '#3b82f6', icon: '‚ö°', gradient: 'from-blue-500 to-indigo-600' },
            { id: 'info', name: 'Info', color: '#eab308', icon: 'üíª', gradient: 'from-yellow-400 to-orange-500' },
            { id: 's2i', name: 'S2I', color: '#10b981', icon: '‚öôÔ∏è', gradient: 'from-emerald-400 to-teal-500' },
        ];

        // --- ICONS ---
        const Icon = ({ path, className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                {path}
            </svg>
        );

        const ICONS = {
            plus: <path d="M12 5v14M5 12h14"/>,
            x: <path d="M18 6L6 18M6 6l12 12"/>,
            chart: <path d="M12 20V10M18 20V4M6 20v-4"/>,
            user: <g><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></g>,
            check: <path d="M20 6L9 17l-5-5"/>,
            lock: <g><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></g>,
            gift: <g><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></g>,
            logOut: <g><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></g>,
            play: <polygon points="5 3 19 12 5 21 5 3"/>,
            flame: <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3a1 1 0 0 1 1.9.8z"/>,
            cloud: <path d="M17.5 19c0-1.7-1.3-3-3-3h-11a4 4 0 0 1-3.8-5.1 4 4 0 0 1 4.3-3.9c1.9 0 3.6.8 4.9 2.1a5 5 0 0 1 8.6 1.9 3 3 0 0 1 0 6z"/>
        };

        // --- AUTH COMPONENT ---
        const AuthView = ({ onLogin, isConnecting }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [formData, setFormData] = useState({ username: '', password: '' });
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async () => {
                setError('');
                if(!formData.username || !formData.password) return setError("Veuillez tout remplir.");
                
                setLoading(true);
                const usernameKey = formData.username.toLowerCase().replace(/\s+/g, '_');
                const userDocRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', COLLECTION_NAME, usernameKey);

                try {
                    const docSnap = await window.getDoc(userDocRef);

                    if (isRegister) {
                        if (docSnap.exists()) {
                            setError("Ce pseudo est d√©j√† pris !");
                        } else {
                            const newUser = {
                                password: formData.password,
                                data: {
                                    profile: { name: formData.username, xp: 0, avatar: "üë§", theme: "blue" },
                                    courses: []
                                }
                            };
                            await window.setDoc(userDocRef, newUser);
                            onLogin(usernameKey, newUser.data);
                        }
                    } else {
                        if (docSnap.exists()) {
                            const userData = docSnap.data();
                            if (userData.password === formData.password) {
                                onLogin(usernameKey, userData.data);
                            } else {
                                setError("Mot de passe incorrect.");
                            }
                        } else {
                            setError("Compte introuvable.");
                        }
                    }
                } catch (err) {
                    console.error("Erreur Auth:", err);
                    setError("Erreur de connexion. R√©essayez.");
                } finally {
                    setLoading(false);
                }
            };

            if (isConnecting) return (
                <div className="min-h-screen flex items-center justify-center bg-[#020617] text-cyan-400 font-mono animate-pulse">
                    Connexion au Neural Cloud...
                </div>
            );

            return (
                <div className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden bg-[#020617]">
                    <div className="absolute inset-0 overflow-hidden pointer-events-none">
                        <div className="absolute top-[-20%] left-[-10%] w-[60%] h-[60%] bg-blue-600/10 rounded-full blur-[120px] animate-float"></div>
                        <div className="absolute bottom-[-20%] right-[-10%] w-[60%] h-[60%] bg-purple-600/10 rounded-full blur-[120px] animate-float" style={{animationDelay: '3s'}}></div>
                    </div>

                    <div className="glass w-full max-w-md p-10 rounded-3xl animate-fade-in relative z-10 border border-slate-700/50">
                        <div className="text-center mb-10">
                            <div className="w-20 h-20 bg-gradient-to-tr from-cyan-500 to-blue-600 rounded-2xl mx-auto flex items-center justify-center mb-6 shadow-2xl shadow-cyan-500/20 rotate-3 hover:rotate-6 transition-transform duration-500">
                                <span className="text-4xl text-white">üß†</span>
                            </div>
                            <h1 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-400 mb-2">NeuroFlow</h1>
                            <p className="text-slate-400 font-medium flex items-center justify-center gap-2">
                                <Icon path={ICONS.cloud} className="w-4 h-4"/> Cloud Sync Activ√©
                            </p>
                        </div>

                        <div className="space-y-5">
                            <div className="group">
                                <label className="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2 ml-1">Pseudo</label>
                                <input 
                                    type="text" 
                                    className="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-5 py-4 text-white focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 outline-none transition-all"
                                    value={formData.username}
                                    onChange={e => setFormData({...formData, username: e.target.value})}
                                    placeholder="Votre identifiant"
                                />
                            </div>
                            <div className="group">
                                <label className="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2 ml-1">Mot de passe</label>
                                <input 
                                    type="password" 
                                    className="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-5 py-4 text-white focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 outline-none transition-all"
                                    value={formData.password}
                                    onChange={e => setFormData({...formData, password: e.target.value})}
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                />
                            </div>

                            {error && <div className="text-rose-400 text-sm text-center bg-rose-500/10 py-3 rounded-xl border border-rose-500/20 animate-pulse">{error}</div>}

                            <button onClick={handleSubmit} disabled={loading} className={`w-full py-4 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold rounded-xl shadow-lg shadow-cyan-500/20 transition-all duration-300 transform hover:scale-[1.02] active:scale-95 mt-4 flex items-center justify-center gap-2 ${loading ? 'opacity-70 cursor-wait' : ''}`}>
                                {loading ? "Synchronisation..." : (isRegister ? "Cr√©er un compte" : "Se connecter")}
                            </button>

                            <div className="text-center pt-6">
                                <button onClick={() => { setIsRegister(!isRegister); setError(''); }} className="text-slate-500 hover:text-cyan-400 text-sm font-medium transition-colors">
                                    {isRegister ? "D√©j√† un compte ? Connexion" : "Nouveau ? Cr√©er un compte"}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function NeuroFlowApp() {
            const [isFirebaseReady, setIsFirebaseReady] = useState(false);
            const [sessionUserKey, setSessionUserKey] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [courses, setCourses] = useState([]);
            
            const [view, setView] = useState('home');
            const [selectedCourse, setSelectedCourse] = useState(null);
            const [newCourse, setNewCourse] = useState({ title: '', subject: 'maths' });

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof window.auth !== 'undefined') {
                            if (window.initialAuthToken) {
                                await window.signInWithCustomToken(window.auth, window.initialAuthToken);
                            } else {
                                await window.signInAnonymously(window.auth);
                            }
                            setIsFirebaseReady(true);
                        } else {
                            setTimeout(initAuth, 500);
                        }
                    } catch (e) {
                        console.error("Auth Error", e);
                    }
                };
                initAuth();
            }, []);

            useEffect(() => {
                if (!sessionUserKey) return;
                const userDocRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', COLLECTION_NAME, sessionUserKey);
                const unsubscribe = window.onSnapshot(userDocRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data().data;
                        setUserProfile(data.profile);
                        setCourses(data.courses);
                    }
                });
                return () => unsubscribe();
            }, [sessionUserKey]);

            const saveToCloud = async (newProfile, newCourses) => {
                if (!sessionUserKey) return;
                if (newProfile) setUserProfile(newProfile);
                if (newCourses) setCourses(newCourses);

                try {
                    const userDocRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', COLLECTION_NAME, sessionUserKey);
                    const payload = {
                        data: {
                            profile: newProfile || userProfile,
                            courses: newCourses || courses
                        }
                    };
                    await window.setDoc(userDocRef, payload, { merge: true });
                } catch (e) {
                    console.error("Save Error", e);
                }
            };

            const handleLogin = (userKey, initialData) => {
                setSessionUserKey(userKey);
                setUserProfile(initialData.profile);
                setCourses(initialData.courses);
                setView('home');
                confetti({ particleCount: 50, spread: 70, origin: { y: 0.8 } });
            };

            const handleLogout = () => {
                setSessionUserKey(null);
                setUserProfile(null);
                setCourses([]);
                setView('login');
            };

            if (!isFirebaseReady) return <div className="min-h-screen bg-[#020617] flex items-center justify-center text-cyan-500 animate-pulse">Initialisation du syst√®me...</div>;
            if (!sessionUserKey || !userProfile) return <AuthView onLogin={handleLogin} isConnecting={!isFirebaseReady} />;

            const activeTheme = THEMES[userProfile.theme] || THEMES.blue;
            const currentLevel = LEVELS.slice().reverse().find(l => userProfile.xp >= l.xp) || LEVELS[0];
            const nextLevel = LEVELS.find(l => l.lvl === currentLevel.lvl + 1);
            const progress = nextLevel ? ((userProfile.xp - currentLevel.xp) / (nextLevel.xp - currentLevel.xp)) * 100 : 100;

            const handleCreateCourse = () => {
                if (!newCourse.title) return;
                const course = {
                    id: Date.now(),
                    title: newCourse.title,
                    subject: newCourse.subject,
                    created: new Date().toISOString(),
                    history: [] // 0 r√©vision √† la cr√©ation
                };
                const updatedCourses = [...courses, course];
                saveToCloud(null, updatedCourses);
                setNewCourse({ title: '', subject: 'maths' });
                setView('home');
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 }, colors: ['#22d3ee', '#e879f9'] });
            };

            const getReviewsToday = (course) => {
                const todayStr = new Date().toDateString();
                return course.history.filter(date => new Date(date).toDateString() === todayStr).length;
            };

            const markAsReviewed = (course) => {
                if (getReviewsToday(course) >= MAX_DAILY_REVIEWS) return;

                const now = new Date().toISOString();
                const updatedCourses = courses.map(c => c.id === course.id ? { ...c, history: [...c.history, now] } : c);
                
                const xpGain = 100; 
                const newXp = userProfile.xp + xpGain;
                const updatedProfile = { ...userProfile, xp: newXp };

                const newLvlObj = LEVELS.slice().reverse().find(l => newXp >= l.xp);
                if (newLvlObj.lvl > currentLevel.lvl) {
                    confetti({ particleCount: 200, spread: 100, origin: { y: 0.5 } });
                    alert(`UPGRADE ! Niveau ${newLvlObj.lvl} atteint.`);
                } else {
                    confetti({ particleCount: 30, spread: 40, origin: { y: 0.7 }, colors: ['#ffffff', activeTheme.bg.split('-')[1]] });
                }

                saveToCloud(updatedProfile, updatedCourses);
            };

            const getRetentionCurves = (course) => {
                const data = [];
                const now = new Date();
                const reviewCount = course.history.length;
                const hasReviews = reviewCount > 0;
                const stability = hasReviews ? 2 * Math.pow(2.2, reviewCount - 1) : 1; 
                const lastEventDate = hasReviews ? new Date(course.history[reviewCount - 1]) : new Date(course.created);

                for (let i = 0; i <= 30; i++) {
                    const projectedDate = new Date();
                    projectedDate.setDate(now.getDate() + i);
                    
                    const daysSinceLastEvent = (projectedDate - lastEventDate) / (1000 * 60 * 60 * 24);
                    let realRetention = 100 * Math.exp(-daysSinceLastEvent / stability);
                    if (daysSinceLastEvent < 0) realRetention = 100;

                    const daysSinceCreation = (projectedDate - new Date(course.created)) / (1000 * 60 * 60 * 24);
                    const theoreticalRetention = 100 * Math.exp(-daysSinceCreation / 1.5); 

                    data.push({
                        day: `J+${i}`,
                        real: Math.round(Math.max(0, Math.min(100, realRetention))),
                        theo: Math.round(Math.max(0, Math.min(100, theoreticalRetention)))
                    });
                }
                return data;
            };

            const CustomTooltip = ({ active, payload, label }) => {
                if (active && payload && payload.length) {
                    const realData = payload.find(p => p.dataKey === 'real');
                    const theoData = payload.find(p => p.dataKey === 'theo');
                    return (
                        <div className="bg-slate-900/90 border border-slate-600 p-4 rounded-xl shadow-2xl backdrop-blur-md">
                            <p className="font-bold text-white mb-2 border-b border-slate-700 pb-1">{label}</p>
                            {realData && (
                                <div className="flex items-center gap-2 mb-1">
                                    <div className="w-2 h-2 rounded-full bg-cyan-400"></div>
                                    <span className="text-slate-300 text-xs">Actuel :</span>
                                    <span className="text-cyan-400 font-mono font-bold">{realData.value}%</span>
                                </div>
                            )}
                            {theoData && (
                                <div className="flex items-center gap-2">
                                    <div className="w-2 h-2 rounded-full bg-rose-500"></div>
                                    <span className="text-slate-300 text-xs">Risque :</span>
                                    <span className="text-rose-400 font-mono font-bold">{theoData.value}%</span>
                                </div>
                            )}
                        </div>
                    );
                }
                return null;
            };

            const renderHome = () => (
                <div className="max-w-7xl mx-auto p-4 md:p-8 space-y-10 animate-fade-in pb-24">
                    <div className="glass rounded-3xl p-6 md:p-8 relative overflow-hidden flex flex-col md:flex-row items-center gap-8 border-t border-white/10">
                        <div className={`absolute top-0 right-0 w-96 h-96 bg-gradient-to-br ${activeTheme.bg} opacity-20 rounded-full blur-[100px] pointer-events-none translate-x-1/3 -translate-y-1/3`}></div>
                        
                        <div className="relative group">
                            <div className={`absolute inset-0 bg-gradient-to-r ${activeTheme.bg} rounded-full blur opacity-50 group-hover:opacity-100 transition-opacity duration-500`}></div>
                            <div className="w-24 h-24 rounded-full bg-slate-900 flex items-center justify-center text-5xl relative z-10 border-4 border-slate-800 shadow-xl">
                                {userProfile.avatar}
                            </div>
                            <div className={`absolute -bottom-2 left-1/2 transform -translate-x-1/2 px-3 py-1 bg-slate-900 rounded-full text-xs font-bold border border-slate-700 text-white whitespace-nowrap z-20`}>
                                Niv. {currentLevel.lvl}
                            </div>
                        </div>
                        
                        <div className="flex-1 w-full text-center md:text-left z-10">
                            <div className="flex items-center justify-center md:justify-between mb-2">
                                <div>
                                    <h1 className="text-3xl font-black text-white tracking-tight">{userProfile.name}</h1>
                                    <div className={`text-sm font-semibold uppercase tracking-widest ${activeTheme.text}`}>{currentLevel.title}</div>
                                </div>
                                <div className="hidden md:block text-right">
                                    <div className="text-2xl font-mono font-bold text-white">{userProfile.xp} <span className="text-sm text-slate-500">XP</span></div>
                                    <div className="text-xs text-slate-400">Prochain: {nextLevel ? nextLevel.reward.name : 'Max'}</div>
                                </div>
                            </div>
                            
                            <div className="relative h-6 bg-slate-900/80 rounded-full p-1 border border-slate-700 shadow-inner">
                                <div className={`h-full rounded-full bg-gradient-to-r ${activeTheme.bg} transition-all duration-1000 relative overflow-hidden`} style={{ width: `${progress}%` }}>
                                    <div className="absolute inset-0 bg-white/20 animate-[pulse_2s_infinite]"></div>
                                </div>
                            </div>
                            <div className="md:hidden flex justify-between text-xs text-slate-500 mt-2 font-mono">
                                <span>{userProfile.xp} XP</span>
                                <span>Next: {nextLevel ? nextLevel.xp : 'MAX'}</span>
                            </div>
                        </div>

                        <div className="flex gap-4 z-10">
                            <button onClick={() => setView('profile')} className="p-4 bg-slate-800 hover:bg-slate-700 rounded-2xl border border-slate-700 transition hover:scale-105 active:scale-95 group" title="Profil">
                                <Icon path={ICONS.user} className="w-6 h-6 text-slate-400 group-hover:text-white transition-colors" />
                            </button>
                            <button onClick={() => setView('builder')} className={`px-6 py-4 rounded-2xl font-bold text-white bg-gradient-to-r ${activeTheme.bg} shadow-lg shadow-cyan-500/20 flex items-center gap-3 transition-all hover:scale-105 active:scale-95`}>
                                <Icon path={ICONS.plus} className="w-6 h-6" /> <span className="hidden md:inline">Nouveau Cours</span>
                            </button>
                            <button onClick={handleLogout} className="p-4 bg-slate-800 hover:bg-rose-500/10 rounded-2xl border border-slate-700 hover:border-rose-500/50 transition group" title="D√©connexion">
                                <Icon path={ICONS.logOut} className="w-6 h-6 text-slate-400 group-hover:text-rose-400" />
                            </button>
                        </div>
                    </div>

                    <div>
                        <h2 className="text-xl font-bold text-white mb-6 flex items-center gap-3">
                            <Icon path={ICONS.flame} className="w-6 h-6 text-orange-500" /> Vos Cours Actifs
                        </h2>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {courses.length === 0 ? (
                                <div className="col-span-full py-24 text-center glass rounded-3xl border-2 border-dashed border-slate-700 flex flex-col items-center justify-center gap-4">
                                    <div className="text-6xl opacity-50 mb-2">üöÄ</div>
                                    <h3 className="text-xl font-bold text-white">Votre tableau de bord est vide</h3>
                                    <p className="text-slate-400 max-w-sm mx-auto">Commencez votre voyage d'apprentissage en cr√©ant votre premier cours.</p>
                                    <button onClick={() => setView('builder')} className={`mt-4 px-8 py-3 rounded-xl font-bold text-white bg-gradient-to-r ${activeTheme.bg}`}>D√©coller maintenant</button>
                                </div>
                            ) : courses.map(course => {
                                const sub = SUBJECTS.find(s => s.id === course.subject);
                                const isSelected = selectedCourse && selectedCourse.id === course.id;
                                const reviewsToday = getReviewsToday(course);
                                const isLimitReached = reviewsToday >= MAX_DAILY_REVIEWS;
                                const lastRevDate = course.history.length > 0 ? new Date(course.history[course.history.length - 1]) : null;

                                return (
                                    <div key={course.id} className={`glass-card rounded-3xl p-6 relative group overflow-hidden ${isSelected ? 'ring-2 ring-cyan-500/50' : ''}`}>
                                        <div className="flex justify-between items-start mb-6">
                                            <div className="flex items-center gap-3">
                                                <div className={`w-12 h-12 rounded-2xl bg-gradient-to-br ${sub.gradient} flex items-center justify-center text-2xl shadow-lg`}>
                                                    {sub.icon}
                                                </div>
                                                <div>
                                                    <div className="text-xs font-bold uppercase tracking-wider text-slate-400 mb-0.5">{sub.name}</div>
                                                    <h3 className="text-lg font-bold text-white leading-tight truncate max-w-[150px]">{course.title}</h3>
                                                </div>
                                            </div>
                                            <button onClick={() => setSelectedCourse(isSelected ? null : course)} className={`p-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 transition ${isSelected ? 'text-cyan-400 bg-cyan-900/20' : ''}`}>
                                                <Icon path={ICONS.chart} className="w-5 h-5" />
                                            </button>
                                        </div>

                                        {isSelected && (
                                            <div className="h-40 -mx-2 mb-6 animate-fade-in relative bg-slate-900/50 rounded-xl border border-slate-700/50 overflow-hidden">
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <AreaChart data={getRetentionCurves(course)}>
                                                        <defs>
                                                            <linearGradient id="colorReal" x1="0" y1="0" x2="0" y2="1">
                                                                <stop offset="5%" stopColor="#22d3ee" stopOpacity={0.3}/>
                                                                <stop offset="95%" stopColor="#22d3ee" stopOpacity={0}/>
                                                            </linearGradient>
                                                        </defs>
                                                        <Tooltip content={<CustomTooltip />} cursor={{stroke: 'rgba(255,255,255,0.1)', strokeWidth: 2}} />
                                                        <Area type="monotone" dataKey="real" stroke="#22d3ee" strokeWidth={3} fillOpacity={1} fill="url(#colorReal)" />
                                                        <Line type="monotone" dataKey="theo" stroke="#ef4444" strokeWidth={2} dot={false} strokeDasharray="4 4" opacity={0.5} />
                                                    </AreaChart>
                                                </ResponsiveContainer>
                                            </div>
                                        )}

                                        <div className="mt-auto">
                                            {isLimitReached ? (
                                                <button disabled className="w-full py-4 rounded-xl bg-slate-800/50 border border-slate-700 text-slate-500 font-bold flex items-center justify-center gap-2 cursor-not-allowed">
                                                    <Icon path={ICONS.check} className="w-5 h-5" /> Quota atteint
                                                </button>
                                            ) : (
                                                <button 
                                                    onClick={() => markAsReviewed(course)}
                                                    className={`w-full py-4 rounded-xl font-bold text-white bg-gradient-to-r ${activeTheme.bg} shadow-lg shadow-cyan-500/20 flex items-center justify-center gap-2 transition-all hover:scale-[1.02] active:scale-95 group-hover:shadow-cyan-500/40`}
                                                >
                                                    <Icon path={ICONS.play} className="w-5 h-5 fill-current" /> <span className="tracking-wide">R√âVISER</span>
                                                </button>
                                            )}
                                            
                                            <div className="mt-3 flex justify-between items-center text-xs font-medium text-slate-500">
                                                <span className="flex items-center gap-1">
                                                    <span className={`w-2 h-2 rounded-full ${isLimitReached ? 'bg-green-500' : 'bg-orange-500 animate-pulse'}`}></span>
                                                    {isLimitReached ? 'Fait' : 'En attente'}
                                                </span>
                                                <span>{lastRevDate ? `Derni√®re: ${lastRevDate.toLocaleDateString()}` : 'Jamais r√©vis√©'}</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );

            const renderBuilder = () => (
                <div className="fixed inset-0 bg-[#020617]/90 backdrop-blur-md z-50 flex items-center justify-center p-4">
                    <div className="glass w-full max-w-lg rounded-3xl p-8 animate-fade-in border border-slate-700 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 to-purple-600"></div>
                        <div className="flex justify-between items-center mb-8">
                            <h2 className="text-2xl font-black text-white tracking-tight">Nouveau Module</h2>
                            <button onClick={() => setView('home')} className="p-2 hover:bg-slate-800 rounded-full transition text-slate-400 hover:text-white"><Icon path={ICONS.x} className="w-6 h-6"/></button>
                        </div>
                        <div className="space-y-6">
                            <div>
                                <label className="block text-slate-400 text-xs font-bold uppercase mb-2 ml-1">Titre du cours</label>
                                <input type="text" className="w-full bg-slate-900 border border-slate-700 rounded-xl px-5 py-4 text-white text-lg font-medium focus:border-cyan-500 outline-none transition-all placeholder:text-slate-600" placeholder="Ex: M√©canique Quantique" value={newCourse.title} onChange={e => setNewCourse({...newCourse, title: e.target.value})} autoFocus />
                            </div>
                            <div>
                                <label className="block text-slate-400 text-xs font-bold uppercase mb-2 ml-1">Domaine</label>
                                <div className="grid grid-cols-2 gap-3">
                                    {SUBJECTS.map(s => (
                                        <button key={s.id} onClick={() => setNewCourse({...newCourse, subject: s.id})} className={`p-4 rounded-xl border-2 flex items-center gap-3 transition-all ${newCourse.subject === s.id ? 'border-white bg-slate-800' : 'border-transparent bg-slate-900 opacity-60 hover:opacity-100'}`}>
                                            <span className="text-2xl">{s.icon}</span><span className="font-bold text-white">{s.name}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <button onClick={handleCreateCourse} className={`w-full py-4 rounded-xl font-bold text-white bg-gradient-to-r ${activeTheme.bg} shadow-xl hover:scale-[1.02] active:scale-95 transition-all mt-4`}>Initialiser le Cours</button>
                        </div>
                    </div>
                </div>
            );

            const renderProfile = () => (
                <div className="fixed inset-0 bg-[#020617]/90 backdrop-blur-md z-50 flex items-center justify-center p-4">
                    <div className="glass w-full max-w-3xl rounded-3xl border border-slate-700 shadow-2xl flex flex-col max-h-[85vh] animate-fade-in overflow-hidden">
                        <div className="p-6 border-b border-slate-700/50 flex justify-between items-center bg-slate-900/50">
                            <h2 className="text-xl font-black text-white uppercase tracking-widest flex items-center gap-3"><span className="text-3xl">üõ°Ô∏è</span> Armurerie</h2>
                            <button onClick={() => setView('home')} className="p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-white transition"><Icon path={ICONS.x} className="w-6 h-6"/></button>
                        </div>
                        <div className="p-8 overflow-y-auto custom-scrollbar space-y-10 bg-slate-900/30">
                            <section>
                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Identit√© Visuelle</h3>
                                <div className="grid grid-cols-4 sm:grid-cols-6 gap-4">
                                    {['üë®‚Äçüéì', 'üë©‚Äçüéì', 'üß†', 'ü¶Å', 'üöÄ', 'üëë'].map((emoji, i) => {
                                        const locked = i > 1 && currentLevel.lvl < (i + 1); 
                                        return (
                                            <button key={i} disabled={locked} onClick={() => saveToCloud({...userProfile, avatar: emoji}, null)} className={`aspect-square rounded-2xl flex items-center justify-center text-4xl border-2 transition-all relative group ${userProfile.avatar === emoji ? `border-cyan-500 bg-cyan-900/20 shadow-[0_0_20px_rgba(34,211,238,0.3)]` : 'border-slate-700 bg-slate-800'} ${locked ? 'opacity-40 grayscale cursor-not-allowed' : 'hover:-translate-y-1 hover:border-slate-500'}`}>
                                                {locked && <div className="absolute inset-0 flex items-center justify-center bg-black/50 rounded-xl"><Icon path={ICONS.lock} className="w-6 h-6 text-white"/></div>}
                                                {emoji}
                                            </button>
                                        );
                                    })}
                                </div>
                            </section>
                            <section>
                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Interface Syst√®me</h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    {Object.entries(THEMES).map(([key, t]) => {
                                        const levelObj = LEVELS.find(l => l.reward.type === 'theme' && l.reward.id === key);
                                        const requiredLvl = levelObj ? levelObj.lvl : 1;
                                        const locked = currentLevel.lvl < requiredLvl;
                                        return (
                                            <button key={key} disabled={locked} onClick={() => saveToCloud({...userProfile, theme: key}, null)} className={`p-5 rounded-2xl border-2 flex items-center justify-between transition-all group ${userProfile.theme === key ? `border-${t.border.split('-')[1]}-500 bg-slate-800 shadow-lg` : 'border-slate-700 bg-slate-900'} ${locked ? 'opacity-50 cursor-not-allowed' : 'hover:border-slate-500'}`}>
                                                <div className="flex items-center gap-4">
                                                    <div className={`w-12 h-12 rounded-full bg-gradient-to-br ${t.bg} shadow-inner`}></div>
                                                    <div className="text-left"><div className="font-bold text-white text-lg capitalize">{key}</div><div className="text-xs font-mono text-slate-400">{locked ? `REQ: LVL ${requiredLvl}` : 'UNLOCKED'}</div></div>
                                                </div>
                                                {locked ? <Icon path={ICONS.lock} className="w-6 h-6 text-slate-600"/> : userProfile.theme === key && <div className="w-4 h-4 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"></div>}
                                            </button>
                                        );
                                    })}
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen font-sans text-slate-200">
                    {view === 'home' && renderHome()}
                    {view === 'builder' && renderBuilder()}
                    {view === 'profile' && renderProfile()}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<NeuroFlowApp />);
    </script>
</body>
</html>
