import React, { useState, useEffect, useMemo } from 'react';
import { 
  LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, AreaChart, Area, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, ReferenceLine
} from 'recharts';
import { 
  BookOpen, Brain, TrendingUp, Calendar, Plus, 
  FileText, CheckCircle, XCircle, Award, Zap, 
  ChevronRight, Upload, Trash2, RotateCcw, Activity, Clock,
  User, Settings, LogOut, Sparkles, PlusCircle
} from 'lucide-react';

// --- DATA TYPES & INITIAL STATE ---

const SUBJECTS = [
  { id: 'maths', name: 'Math√©matiques', color: '#8884d8', icon: 'üìê' },
  { id: 'pc', name: 'Physique-Chimie', color: '#82ca9d', icon: 'üß™' },
  { id: 's2i', name: 'S2I', color: '#ffc658', icon: '‚öôÔ∏è' },
  { id: 'info', name: 'Informatique', color: '#ff7300', icon: 'üíª' }
];

// √âtat initial vide ou presque pour un nouvel utilisateur
const INITIAL_TOPICS = [
  { 
    id: 1, 
    subject: 'info', 
    title: 'Exemple: Bienvenue sur NeuroFlow', 
    level: 1, 
    interval: 0,
    nextReview: new Date().toISOString(), 
    lastReviewed: null, 
    content: 'Ceci est une carte exemple. Cr√©ez les v√¥tres via le bouton "Cr√©er" dans le menu √† gauche.', 
    status: 'new',
    history: [] // Pour stocker l'historique des r√©visions et tracer la courbe
  }
];

// --- UTILS ---

// Algorithme de R√©p√©tition Espac√©e (Am√©lior√© pour pr√©dictions)
// Retourne l'intervalle en jours pour chaque choix
const getNextIntervals = (currentInterval, currentLevel) => {
  // Logique simplifi√©e type SuperMemo
  // Intervalle minimum 1 jour
  const safeInterval = Math.max(currentInterval, 1);
  
  return {
    again: 0, // A revoir aujourd'hui
    hard: 1, // Demain
    good: Math.ceil(safeInterval * 1.5 + currentLevel), // Croissance mod√©r√©e
    easy: Math.ceil(safeInterval * 2.5 + currentLevel * 2) // Croissance forte
  };
};

const formatDate = (dateString) => {
  const options = { weekday: 'short', day: 'numeric', month: 'short' };
  return new Date(dateString).toLocaleDateString('fr-FR', options);
};

const formatTimeDelta = (days) => {
  if (days === 0) return 'Auj.';
  if (days === 1) return 'Demain';
  return `+${days}j`;
};

// G√©n√©rateur de donn√©es pour la courbe de l'oubli sp√©cifique √† un topic
const generateTopicCurveData = (topic) => {
  const data = [];
  const now = new Date();
  const createdDate = topic.history.length > 0 ? new Date(topic.history[0].date) : new Date();
  
  // 1. Courbe th√©orique (Oubli naturel sans r√©vision apr√®s apprentissage initial)
  // Mod√®le exponentiel R = e^(-t/S)
  
  // 2. Courbe r√©elle (Dents de scie bas√©es sur l'historique)
  let currentStability = 2; // Stabilit√© initiale (jours avant d'atteindre 90% oubli)
  let lastReviewDate = createdDate;
  
  // Simuler 30 jours ou jusqu'√† la prochaine r√©vision pr√©vue + 10 jours
  const maxDays = 30; 

  for (let i = 0; i <= maxDays; i++) {
    const dateAtI = new Date(createdDate);
    dateAtI.setDate(createdDate.getDate() + i);
    
    // Calcul th√©orique (Si on avait jamais r√©vis√© apr√®s le jour 0)
    const theoreticalRetention = 100 * Math.exp(-i / 3); // D√©croissance rapide

    // Calcul R√©el (Bas√© sur l'historique)
    let realRetention = 0;
    
    // Trouver la derni√®re r√©vision avant cette date 'i'
    const pastReviews = topic.history.filter(h => new Date(h.date) <= dateAtI);
    
    if (pastReviews.length === 0) {
      // Pas encore r√©vis√© (ou jour 0)
      const daysSinceCreation = i;
      realRetention = 100 * Math.exp(-daysSinceCreation / currentStability);
    } else {
      // A √©t√© r√©vis√©
      const lastReview = pastReviews[pastReviews.length - 1];
      const daysSinceLastReview = (dateAtI - new Date(lastReview.date)) / (1000 * 60 * 60 * 24);
      
      // La stabilit√© augmente √† chaque r√©vision (simplification visuelle)
      // Dans une vraie app, on stockerait la stabilit√© calcul√©e √† chaque √©tape
      const effectiveStability = currentStability * Math.pow(1.8, pastReviews.length); 
      
      realRetention = 100 * Math.exp(-daysSinceLastReview / effectiveStability);
    }

    // Remonter √† 100% les jours de r√©vision exacts (pour le visuel en dents de scie)
    const isReviewDay = topic.history.some(h => {
        const d = new Date(h.date);
        return d.getDate() === dateAtI.getDate() && d.getMonth() === dateAtI.getMonth();
    });
    if (isReviewDay || i === 0) realRetention = 100;

    data.push({
      day: `J+${i}`,
      theoretical: theoreticalRetention,
      real: realRetention
    });
  }
  return data;
};

// --- COMPONENTS ---

export default function StudyFlow() {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [topics, setTopics] = useState(INITIAL_TOPICS);
  const [userStats, setUserStats] = useState({ xp: 0, level: 1, streak: 1 });
  
  const [selectedTopic, setSelectedTopic] = useState(null); // Pour la r√©vision
  const [analyzingTopic, setAnalyzingTopic] = useState(null); // Pour le graphique d√©taill√©
  
  const [showAddModal, setShowAddModal] = useState(false);
  const [newTopicForm, setNewTopicForm] = useState({ title: '', subject: 'maths', content: '' });

  // --- DERIVED DATA ---
  
  const today = new Date();
  
  const dueTopics = useMemo(() => {
    return topics.filter(t => new Date(t.nextReview) <= today).sort((a,b) => new Date(a.nextReview) - new Date(b.nextReview));
  }, [topics]);

  const levelProgress = (userStats.xp % 1000) / 10; 

  // --- ACTIONS ---

  const handleReview = (rating) => {
    if (!selectedTopic) return;

    const intervals = getNextIntervals(selectedTopic.interval || 0, selectedTopic.level);
    
    let nextInterval = 0;
    if (rating === 'easy') nextInterval = intervals.easy;
    if (rating === 'good') nextInterval = intervals.good;
    if (rating === 'hard') nextInterval = intervals.hard;
    if (rating === 'again') nextInterval = intervals.again;

    const nextDate = new Date();
    nextDate.setDate(nextDate.getDate() + nextInterval);
    
    // XP Calculation
    let xpGain = rating === 'easy' ? 20 : rating === 'good' ? 15 : rating === 'hard' ? 10 : 5;

    // Update State
    const updatedTopics = topics.map(t => {
      if (t.id === selectedTopic.id) {
        return { 
          ...t, 
          level: t.level + 1,
          interval: nextInterval,
          nextReview: nextDate.toISOString(),
          lastReviewed: new Date().toISOString(),
          status: 'reviewed',
          history: [...t.history, { date: new Date().toISOString(), rating }]
        };
      }
      return t;
    });

    setTopics(updatedTopics);
    setUserStats(prev => ({
      ...prev,
      xp: prev.xp + xpGain,
      level: Math.floor((prev.xp + xpGain) / 1000) + 1
    }));
    
    setSelectedTopic(null);
  };

  const handleAddTopic = () => {
    if (!newTopicForm.title) return;
    const newId = Date.now(); // Unique ID simple
    const newTopic = {
      id: newId,
      subject: newTopicForm.subject,
      title: newTopicForm.title,
      level: 1,
      interval: 0,
      nextReview: new Date().toISOString(),
      lastReviewed: null,
      content: newTopicForm.content || 'Pas de contenu textuel.',
      status: 'new',
      history: []
    };
    setTopics([...topics, newTopic]);
    setShowAddModal(false);
    setNewTopicForm({ title: '', subject: 'maths', content: '' });
  };

  const handleDeleteTopic = (id) => {
    setTopics(topics.filter(t => t.id !== id));
    if (analyzingTopic && analyzingTopic.id === id) setAnalyzingTopic(null);
  };

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      setNewTopicForm(prev => ({ ...prev, content: `Fichier import√© : ${file.name}\n\n[Contenu simul√© du PDF/Image...]` }));
    }
  };

  // --- SUB-COMPONENTS ---

  const Sidebar = () => (
    <div className="w-20 md:w-64 bg-slate-900/90 backdrop-blur-xl border-r border-white/10 flex flex-col items-center md:items-start py-8 fixed h-full z-10 transition-all">
      <div className="px-6 mb-8 flex items-center gap-3">
        <div className="w-10 h-10 bg-gradient-to-tr from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-500/20">
          <Brain className="text-white w-6 h-6" />
        </div>
        <span className="hidden md:block font-bold text-2xl text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-400">
          NeuroFlow
        </span>
      </div>

      <div className="px-4 mb-6 w-full">
         <button 
           onClick={() => setShowAddModal(true)}
           className="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white p-3 rounded-xl font-bold shadow-lg shadow-cyan-500/20 flex items-center justify-center gap-2 transition-all transform hover:scale-105"
         >
            <PlusCircle className="w-5 h-5" />
            <span className="hidden md:block">Cr√©er</span>
         </button>
      </div>

      <nav className="flex-1 w-full px-4 space-y-2">
        {[
          { id: 'dashboard', icon: LayoutDashboard, label: 'Tableau de bord' },
          { id: 'study', icon: Layers, label: 'Mode R√©vision' },
          { id: 'resources', icon: FolderOpen, label: 'Mes Cours' },
          { id: 'profile', icon: User, label: 'Mon Profil' },
        ].map((item) => (
          <button
            key={item.id}
            onClick={() => setActiveTab(item.id)}
            className={`w-full flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-300 group
              ${activeTab === item.id 
                ? 'bg-blue-600/20 text-blue-400 border border-blue-500/30' 
                : 'text-slate-400 hover:bg-white/5 hover:text-white'
              }`}
          >
            <item.icon className={`w-5 h-5 ${activeTab === item.id ? 'animate-pulse' : ''}`} />
            <span className="hidden md:block font-medium">{item.label}</span>
            {activeTab === item.id && <div className="hidden md:block ml-auto w-1.5 h-1.5 rounded-full bg-blue-400 shadow-[0_0_10px_#60a5fa]" />}
          </button>
        ))}
      </nav>

      <div className="w-full px-4 mt-auto">
        <div className="bg-slate-800/50 rounded-xl p-4 border border-white/5">
          <div className="flex items-center gap-3 mb-2">
            <div className="bg-yellow-500/20 p-2 rounded-lg text-yellow-400">
              <Zap className="w-4 h-4" />
            </div>
            <div className="hidden md:block">
              <div className="text-xs text-slate-400">Niveau {userStats.level}</div>
              <div className="text-sm font-bold text-white">{userStats.xp} XP</div>
            </div>
          </div>
          <div className="h-2 w-full bg-slate-700 rounded-full overflow-hidden">
            <div 
              className="h-full bg-gradient-to-r from-yellow-400 to-orange-500 transition-all duration-1000"
              style={{ width: `${levelProgress}%` }}
            />
          </div>
        </div>
      </div>
    </div>
  );

  // --- VIEWS ---

  const DashboardView = () => (
    <div className="space-y-8 animate-in fade-in zoom-in duration-500">
      <div className="flex justify-between items-end">
        <div>
          <h1 className="text-3xl font-bold text-white mb-2">Bonjour ! üöÄ</h1>
          <p className="text-slate-400">
            {dueTopics.length > 0 
              ? <span>Tu as <span className="text-cyan-400 font-bold">{dueTopics.length} cartes</span> √† r√©viser.</span>
              : "Tout est √† jour. Utilisez le bouton 'Cr√©er' pour ajouter du contenu."}
          </p>
        </div>
        <div className="flex items-center gap-2 bg-slate-800/50 px-4 py-2 rounded-full border border-white/10">
          <Award className="text-orange-400 w-5 h-5" />
          <span className="text-white font-bold">{userStats.streak} jours</span>
        </div>
      </div>

      {/* Main Chart: Global Progress */}
      <div className="bg-slate-800/40 backdrop-blur-md p-6 rounded-2xl border border-white/5">
        <h2 className="text-xl font-bold text-white mb-6 flex items-center gap-2">
          <Activity className="text-cyan-400" />
          Activit√© de R√©vision (Simulation)
        </h2>
        <div className="h-64 w-full">
          <ResponsiveContainer width="100%" height="100%">
            <AreaChart data={[
                {day: 'Lun', val: 2}, {day: 'Mar', val: 5}, {day: 'Mer', val: 3}, 
                {day: 'Jeu', val: 8}, {day: 'Ven', val: 1}, {day: 'Sam', val: 0}, {day: 'Dim', val: dueTopics.length}
            ]}>
              <defs>
                <linearGradient id="colorActivity" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor="#22d3ee" stopOpacity={0.3}/>
                  <stop offset="95%" stopColor="#22d3ee" stopOpacity={0}/>
                </linearGradient>
              </defs>
              <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
              <XAxis dataKey="day" stroke="#94a3b8" />
              <YAxis stroke="#94a3b8" />
              <Tooltip contentStyle={{ backgroundColor: '#1e293b', borderColor: '#334155', color: 'white' }} />
              <Area type="monotone" dataKey="val" stroke="#22d3ee" strokeWidth={3} fill="url(#colorActivity)" />
            </AreaChart>
          </ResponsiveContainer>
        </div>
      </div>
    </div>
  );

  const ProfileView = () => (
    <div className="space-y-8 animate-in slide-in-from-right duration-500">
       <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold text-white">Mon Profil</h2>
        <button className="text-slate-400 hover:text-red-400 flex items-center gap-2 text-sm">
            <LogOut className="w-4 h-4" /> D√©connexion
        </button>
       </div>

       {/* Profile Header */}
       <div className="bg-slate-800/60 backdrop-blur-md p-8 rounded-2xl border border-white/5 flex flex-col md:flex-row items-center md:items-start gap-8 relative overflow-hidden">
         <div className="absolute top-0 right-0 p-32 bg-blue-500/10 blur-[80px] rounded-full pointer-events-none" />
         
         <div className="relative">
            <div className="w-24 h-24 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-full flex items-center justify-center text-3xl font-bold text-white shadow-xl shadow-cyan-500/30 border-4 border-slate-900">
                EF
            </div>
            <div className="absolute -bottom-2 -right-2 bg-slate-900 p-1.5 rounded-full">
                <div className="bg-green-500 w-4 h-4 rounded-full border-2 border-slate-900" />
            </div>
         </div>
         
         <div className="text-center md:text-left flex-1">
            <h3 className="text-2xl font-bold text-white mb-1">√âtudiant Futuriste</h3>
            <p className="text-slate-400 mb-4">Membre depuis le 10 Dec 2025</p>
            
            <div className="flex flex-wrap justify-center md:justify-start gap-3">
                <div className="flex items-center gap-2 bg-blue-500/10 px-4 py-2 rounded-full border border-blue-500/20 text-blue-300">
                    <Zap className="w-4 h-4" />
                    <span className="font-bold">Niveau {userStats.level}</span>
                </div>
                <div className="flex items-center gap-2 bg-orange-500/10 px-4 py-2 rounded-full border border-orange-500/20 text-orange-300">
                    <Award className="w-4 h-4" />
                    <span className="font-bold">{userStats.streak} Jours S√©rie</span>
                </div>
                <div className="flex items-center gap-2 bg-purple-500/10 px-4 py-2 rounded-full border border-purple-500/20 text-purple-300">
                    <Sparkles className="w-4 h-4" />
                    <span className="font-bold">{userStats.xp} XP Total</span>
                </div>
            </div>
         </div>
       </div>

       {/* Stats Overview */}
       <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
           <div className="bg-slate-800/40 p-6 rounded-2xl border border-white/5 flex flex-col items-center text-center hover:bg-slate-800/60 transition-colors">
                <div className="p-3 bg-cyan-500/20 rounded-xl text-cyan-400 mb-3">
                    <FileText className="w-6 h-6" />
                </div>
                <div className="text-3xl font-bold text-white mb-1">{topics.length}</div>
                <div className="text-sm text-slate-400">Total Flashcards</div>
           </div>
           
           <div className="bg-slate-800/40 p-6 rounded-2xl border border-white/5 flex flex-col items-center text-center hover:bg-slate-800/60 transition-colors">
                <div className="p-3 bg-green-500/20 rounded-xl text-green-400 mb-3">
                    <CheckCircle className="w-6 h-6" />
                </div>
                <div className="text-3xl font-bold text-white mb-1">
                    {Math.round((topics.filter(t => t.level > 1).length / Math.max(topics.length, 1)) * 100)}%
                </div>
                <div className="text-sm text-slate-400">Taux de Ma√Ætrise</div>
           </div>

           <div className="bg-slate-800/40 p-6 rounded-2xl border border-white/5 flex flex-col items-center text-center hover:bg-slate-800/60 transition-colors">
                <div className="p-3 bg-pink-500/20 rounded-xl text-pink-400 mb-3">
                    <Clock className="w-6 h-6" />
                </div>
                <div className="text-3xl font-bold text-white mb-1">12h</div>
                <div className="text-sm text-slate-400">Temps d'√©tude (Simul√©)</div>
           </div>
       </div>

       {/* Settings Section (Mock) */}
       <div className="bg-slate-800/40 p-6 rounded-2xl border border-white/5">
            <h4 className="font-bold text-white mb-4 flex items-center gap-2">
                <Settings className="w-5 h-5 text-slate-400" /> Param√®tres de l'application
            </h4>
            <div className="space-y-4">
                <div className="flex justify-between items-center p-3 bg-slate-900/50 rounded-lg">
                    <span className="text-slate-300">Mode Sombre</span>
                    <div className="w-10 h-5 bg-green-500 rounded-full relative cursor-pointer">
                        <div className="absolute right-1 top-1 w-3 h-3 bg-white rounded-full shadow-sm" />
                    </div>
                </div>
                <div className="flex justify-between items-center p-3 bg-slate-900/50 rounded-lg">
                    <span className="text-slate-300">Rappels quotidiens par email</span>
                    <div className="w-10 h-5 bg-slate-600 rounded-full relative cursor-pointer">
                        <div className="absolute left-1 top-1 w-3 h-3 bg-white rounded-full shadow-sm" />
                    </div>
                </div>
                <div className="flex justify-between items-center p-3 bg-slate-900/50 rounded-lg">
                    <span className="text-slate-300">Son des notifications</span>
                    <div className="w-10 h-5 bg-green-500 rounded-full relative cursor-pointer">
                        <div className="absolute right-1 top-1 w-3 h-3 bg-white rounded-full shadow-sm" />
                    </div>
                </div>
            </div>
       </div>
    </div>
  );

  const StudyView = () => (
    <div className="max-w-3xl mx-auto space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold text-white">Session de R√©vision</h2>
        {/* Le bouton Ajouter est maintenant dans la Sidebar pour un acc√®s rapide */}
      </div>

      {dueTopics.length === 0 ? (
        <div className="text-center py-20 bg-slate-800/30 rounded-3xl border border-dashed border-slate-700">
          <div className="inline-block p-6 bg-green-500/10 rounded-full mb-4">
            <CheckCircle className="w-12 h-12 text-green-400" />
          </div>
          <h3 className="text-xl font-bold text-white mb-2">Tout est √† jour !</h3>
          <p className="text-slate-400 max-w-md mx-auto">
            Excellent travail. Vous pouvez ajouter de nouvelles cartes via le menu ou consulter votre profil.
          </p>
        </div>
      ) : (
        <div className="space-y-4">
          {dueTopics.map(topic => {
             const subjectInfo = SUBJECTS.find(s => s.id === topic.subject);
             // Calculate intervals for this specific card to show on buttons
             const intervals = getNextIntervals(topic.interval || 0, topic.level);

             return (
              <div key={topic.id} className="bg-slate-800/80 backdrop-blur-md p-6 rounded-2xl border border-white/5 hover:border-cyan-500/30 transition-all group relative overflow-hidden">
                <div className="absolute top-0 left-0 w-1 h-full" style={{ backgroundColor: subjectInfo.color }} />
                
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <span className="text-xs uppercase tracking-wider font-semibold text-slate-400 mb-1 block">
                      {subjectInfo.name}
                    </span>
                    <h3 className="text-xl font-bold text-white">{topic.title}</h3>
                  </div>
                  <div className="bg-slate-950 p-2 rounded-lg text-slate-400 group-hover:text-cyan-400 transition-colors cursor-pointer" onClick={() => setSelectedTopic(topic)}>
                    <ChevronRight className="w-6 h-6" />
                  </div>
                </div>

                <div className="flex items-center gap-4 text-sm text-slate-500">
                  <span className="flex items-center gap-1">
                    <Clock className="w-3 h-3" /> Intervalle actuel: {topic.interval}j
                  </span>
                </div>

                {selectedTopic && selectedTopic.id === topic.id && (
                  <div className="absolute inset-0 bg-slate-900 z-20 p-6 flex flex-col animate-in slide-in-from-right duration-300">
                    <div className="flex-1 overflow-y-auto mb-4 custom-scrollbar">
                      <div className="flex justify-between items-center mb-4 border-b border-white/10 pb-4">
                        <h3 className="text-lg font-bold text-white">{topic.title}</h3>
                        <button onClick={() => setSelectedTopic(null)} className="text-slate-400 hover:text-white"><XCircle /></button>
                      </div>
                      <div className="prose prose-invert max-w-none whitespace-pre-wrap">
                        <p className="text-slate-300 text-lg leading-relaxed">{topic.content}</p>
                      </div>
                    </div>
                    
                    <div className="grid grid-cols-4 gap-3 mt-auto pt-4 border-t border-white/10">
                      <button onClick={() => handleReview('again')} className="bg-red-500/10 hover:bg-red-500 text-red-400 hover:text-white py-3 rounded-xl flex flex-col items-center justify-center transition-all group-btn">
                        <span className="font-bold">√Ä revoir</span>
                        <span className="text-xs opacity-70 group-btn-hover:text-white">{formatTimeDelta(intervals.again)}</span>
                      </button>
                      <button onClick={() => handleReview('hard')} className="bg-orange-500/10 hover:bg-orange-500 text-orange-400 hover:text-white py-3 rounded-xl flex flex-col items-center justify-center transition-all">
                        <span className="font-bold">Difficile</span>
                        <span className="text-xs opacity-70">{formatTimeDelta(intervals.hard)}</span>
                      </button>
                      <button onClick={() => handleReview('good')} className="bg-blue-500/10 hover:bg-blue-500 text-blue-400 hover:text-white py-3 rounded-xl flex flex-col items-center justify-center transition-all">
                        <span className="font-bold">Correct</span>
                        <span className="text-xs opacity-70">{formatTimeDelta(intervals.good)}</span>
                      </button>
                      <button onClick={() => handleReview('easy')} className="bg-green-500/10 hover:bg-green-500 text-green-400 hover:text-white py-3 rounded-xl flex flex-col items-center justify-center transition-all">
                        <span className="font-bold">Facile</span>
                        <span className="text-xs opacity-70">{formatTimeDelta(intervals.easy)}</span>
                      </button>
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );

  const ResourcesView = () => (
    <div className="space-y-6">
       <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold text-white">Mes Cours & Flashcards</h2>
        {/* Le bouton Ajouter est maintenant dans la Sidebar */}
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {topics.map(topic => (
          <div key={topic.id} className="bg-slate-800/40 p-4 rounded-xl border border-white/5 hover:bg-slate-800/60 transition-colors flex flex-col">
            <div className="flex justify-between items-start mb-2">
              <span className={`px-2 py-1 rounded text-xs font-bold uppercase bg-opacity-20`} style={{ backgroundColor: SUBJECTS.find(s=>s.id===topic.subject).color + '33', color: SUBJECTS.find(s=>s.id===topic.subject).color }}>
                {SUBJECTS.find(s=>s.id===topic.subject).name}
              </span>
              <div className="flex gap-2">
                <button onClick={() => setAnalyzingTopic(topic)} className="text-cyan-500 hover:text-cyan-300" title="Analyser la courbe">
                    <TrendingUp className="w-4 h-4" />
                </button>
                <button onClick={() => handleDeleteTopic(topic.id)} className="text-slate-500 hover:text-red-400">
                    <Trash2 className="w-4 h-4" />
                </button>
              </div>
            </div>
            <h4 className="font-bold text-white mb-2">{topic.title}</h4>
            <div className="text-sm text-slate-400 line-clamp-3 mb-4 flex-1 whitespace-pre-wrap">
              {topic.content}
            </div>
            <div className="flex items-center justify-between text-xs text-slate-500 mt-auto pt-3 border-t border-white/5">
              <span className="flex items-center gap-1"><FileText className="w-3 h-3" /> Flashcard</span>
              <span>Prochaine: {formatDate(topic.nextReview)}</span>
            </div>
          </div>
        ))}
      </div>

      {/* Analysis Modal for a specific topic */}
      {analyzingTopic && (
          <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
             <div className="bg-slate-900 border border-white/10 w-full max-w-2xl rounded-2xl p-6 shadow-2xl">
                <div className="flex justify-between items-center mb-6">
                    <div>
                        <h3 className="text-xl font-bold text-white">Analyse de la R√©tention</h3>
                        <p className="text-slate-400 text-sm">{analyzingTopic.title}</p>
                    </div>
                    <button onClick={() => setAnalyzingTopic(null)} className="text-slate-400 hover:text-white"><XCircle /></button>
                </div>

                <div className="h-64 w-full bg-slate-800/30 rounded-xl p-4 mb-4">
                    <ResponsiveContainer width="100%" height="100%">
                        <LineChart data={generateTopicCurveData(analyzingTopic)}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                            <XAxis dataKey="day" stroke="#94a3b8" interval={4} />
                            <YAxis domain={[0, 100]} stroke="#94a3b8" label={{ value: 'R√©tention %', angle: -90, position: 'insideLeft', fill: '#94a3b8' }} />
                            <Tooltip contentStyle={{ backgroundColor: '#1e293b', borderColor: '#334155', color: 'white' }} />
                            <Legend />
                            {/* Theoretical Natural Forgetting Curve (Red) */}
                            <Line name="Oubli Th√©orique (Sans r√©vision)" type="monotone" dataKey="theoretical" stroke="#ef4444" strokeWidth={2} dot={false} strokeDasharray="5 5" />
                            {/* Real/Projected Retention with Reviews (Green/Blue) */}
                            <Line name="Votre R√©tention R√©elle" type="monotone" dataKey="real" stroke="#22d3ee" strokeWidth={3} dot={false} />
                        </LineChart>
                    </ResponsiveContainer>
                </div>
                
                <p className="text-sm text-slate-400 italic">
                    * La courbe rouge montre comment vous auriez oubli√© cette information sans rappels. 
                    La courbe bleue montre votre courbe "en dents de scie" actuelle gr√¢ce √† vos r√©visions ({analyzingTopic.history.length} r√©visions effectu√©es).
                </p>
             </div>
          </div>
      )}
    </div>
  );

  // --- MAIN RENDER ---

  return (
    <div className="min-h-screen bg-slate-950 text-slate-200 font-sans selection:bg-cyan-500/30">
      <div className="fixed inset-0 z-0 overflow-hidden pointer-events-none">
        <div className="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-blue-900/20 rounded-full blur-[120px]" />
        <div className="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-900/20 rounded-full blur-[120px]" />
      </div>

      <Sidebar />

      <main className="md:ml-64 p-6 md:p-10 relative z-1">
        {activeTab === 'dashboard' && <DashboardView />}
        {activeTab === 'study' && <StudyView />}
        {activeTab === 'resources' && <ResourcesView />}
        {activeTab === 'profile' && <ProfileView />}
      </main>

      {/* Add Modal */}
      {showAddModal && (
        <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
          <div className="bg-slate-900 border border-white/10 w-full max-w-lg rounded-2xl p-6 shadow-2xl animate-in zoom-in duration-200">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-xl font-bold text-white">Ajouter un Sujet / Carte</h3>
              <button onClick={() => setShowAddModal(false)} className="text-slate-400 hover:text-white"><XCircle /></button>
            </div>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm text-slate-400 mb-1">Mati√®re</label>
                <div className="flex gap-2">
                  {SUBJECTS.map(sub => (
                    <button
                      key={sub.id}
                      onClick={() => setNewTopicForm({...newTopicForm, subject: sub.id})}
                      className={`flex-1 py-2 rounded-lg text-sm font-medium border transition-all
                        ${newTopicForm.subject === sub.id 
                          ? `border-[${sub.color}] bg-[${sub.color}]/10 text-white`
                          : 'border-slate-700 text-slate-400 hover:bg-slate-800'
                        }`}
                      style={{ borderColor: newTopicForm.subject === sub.id ? sub.color : '' }}
                    >
                      {sub.name.substring(0, 3)}
                    </button>
                  ))}
                </div>
              </div>

              <div>
                <label className="block text-sm text-slate-400 mb-1">Titre du chapitre / concept</label>
                <input 
                  type="text" 
                  value={newTopicForm.title}
                  onChange={(e) => setNewTopicForm({...newTopicForm, title: e.target.value})}
                  className="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500"
                  placeholder="Ex: Loi d'Ohm"
                />
              </div>

              <div>
                <label className="block text-sm text-slate-400 mb-1">Contenu (Notes / Collage PDF)</label>
                <textarea 
                  rows={4}
                  value={newTopicForm.content}
                  onChange={(e) => setNewTopicForm({...newTopicForm, content: e.target.value})}
                  className="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500 font-mono text-sm"
                  placeholder="Tapez vos notes ou copiez-collez le contenu de vos Flashcards ici..."
                />
              </div>

              <div>
                 <label className="block text-sm text-slate-400 mb-2">Ou importer un fichier (Simul√©)</label>
                 <label className="flex items-center justify-center w-full h-24 border-2 border-dashed border-slate-700 rounded-lg cursor-pointer hover:border-cyan-500 hover:bg-slate-800/50 transition-colors">
                    <div className="flex flex-col items-center pt-5 pb-6">
                        <Upload className="w-8 h-8 text-slate-500 mb-2" />
                        <p className="text-xs text-slate-500">Cliquez pour ajouter PDF/Image</p>
                    </div>
                    <input type="file" className="hidden" onChange={handleFileUpload} />
                 </label>
              </div>
            </div>

            <div className="mt-8 flex justify-end gap-3">
              <button onClick={() => setShowAddModal(false)} className="px-4 py-2 text-slate-400 hover:text-white">Annuler</button>
              <button onClick={handleAddTopic} className="px-6 py-2 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold rounded-lg shadow-lg shadow-cyan-500/20">
                Cr√©er la carte
              </button>
            </div>
          </div>
        </div>
      )}

    </div>
  );
}

// Helpers for Recharts Legend (Must be component to avoid errors in strict mode sometimes)
const Legend = (props) => {
    const { payload } = props;
    if (!payload) return null;
    return (
        <div className="flex justify-center gap-4 mt-2">
            {payload.map((entry, index) => (
            <div key={`item-${index}`} className="flex items-center text-xs text-slate-300">
                <div className="w-3 h-3 mr-1 rounded-full" style={{ backgroundColor: entry.color }} />
                {entry.value}
            </div>
            ))}
        </div>
    );
};

// Icons import helpers
const LayoutDashboard = ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>;
const Layers = ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></svg>;
const BarChart2 = ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></svg>;
const FolderOpen = ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-3.25 7a2 2 0 0 1-1.8 1.18H7a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4h8a2 2 0 0 1 2 2v1"/></svg>;
